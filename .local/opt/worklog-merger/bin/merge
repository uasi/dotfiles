#!/usr/bin/ruby

require 'stringio'

USAGE = <<EOS
usage: merge [--asc|--desc] <worklog-dir> <output-file>
EOS

order = { '--asc' => :asc, '--desc' => :desc }[ARGV[0]]
worklog_dir = ARGV[1]
output_file = ARGV[2]

unless order && worklog_dir && output_file
  $stderr.print USAGE
  exit 1
end

open(output_file, 'w') do |output|
  StringIO.open('temp', 'w+') do |temp|
    worklogs = Dir.glob(File.join(worklog_dir, '*.md'))
    worklogs.sort!
    worklogs.reverse! if order == :desc
    worklogs.each do |worklog|
      open(worklog) do |src|
        IO.copy_stream(src, temp)
        temp.write("\n#{'-' * 78}\n\n")
      end
    end
    temp.write("This file is automatically generated by worklog-merger.\n")
    temp.seek(0)
    IO.copy_stream(temp, output)
  end
end
